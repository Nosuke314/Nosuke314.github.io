<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>記憶クイズアプリ</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background-color: #f4f4f4;
    }

    #display {
      font-size: 36px;
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      min-height: 100px;
      white-space: pre-wrap;
      margin-bottom: 20px;
    }

    .answer-box {
      padding: 20px;
      background-color: #ddd;
      border-radius: 10px;
      text-align: center;
      font-size: 28px;
      cursor: pointer;
      user-select: none;
      margin-bottom: 20px;
    }

    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    button {
      font-size: 20px;
      padding: 10px 20px;
      border: none;
      background-color: #1976d2;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #145ea8;
    }

    .mode-button.active {
      background-color: #f57c00;
    }

    #qa-list {
      margin-top: 20px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th, td {
      border: 1px solid #999;
      padding: 10px;
      text-align: left;
    }

    input[type="checkbox"] {
      transform: scale(1.5);
    }
    .bottom-buttons {
  display: flex;
  justify-content: center;
  gap: 30px;
  margin: 20px 0;
}

.bottom-buttons button {
  font-size: 24px;
  padding: 15px 30px;
  background-color: #388e3c;
  border: none;
  color: white;
  border-radius: 8px;
  cursor: pointer;
}

.bottom-buttons button:hover {
  background-color: #2e7d32;
}
  </style>
</head>
<body>

  <h1>記憶クイズアプリ</h1>

  <div class="buttons">
    <button onclick="setMode('all')" class="mode-button active">全ての問題</button>
    <button onclick="setMode('notMemorized')" class="mode-button">覚えていない問題だけ</button>
    <button onclick="setMode('list')" class="mode-button">問題一覧を見る</button>
    <button onclick="start()">新しい問題を出す</button>
    <button onclick="togglePause()">一時停止</button>
  </div>

  <div id="display"></div>
<div class="bottom-buttons">
  <button onclick="togglePause()">⏸ 一時停止</button>
  <button onclick="start()">⏭ 次の問題へ</button>
</div>
  <div class="answer-box" onclick="showAnswer()">タップして答えを表示</div>
  <div style="margin: 10px 0;">
  <label>
    <input type="checkbox" id="memorizedCheck" onchange="toggleMemorizedCurrent()">
    この問題は覚えた
  </label>
</div>

  <div id="qa-list" style="display:none;"></div>

  <script>
    function toggleMemorizedCurrent() {
  if (currentQAIndex !== null) {
    qaList[currentQAIndex].memorized = document.getElementById("memorizedCheck").checked;
    saveData();
  }
}
    
    let qaList = [
      { question: "文献や文字による記録の存在しない時代をなんという？", answer: "先史時代", memorized: false },
      { question: "最古の化石人類で、原始的な打製石器を使用したと言われるのは？", answer: "猿人", memorized: false },
      { question: "打製石器とは何か？", answer: "石を打ち砕いて作る石器", memorized: false },
      { question: "アウストラロピテクスは何時代の人類？", answer: "猿人", memorized: false }
    ];

    let isPaused = false;
    let isRunning = false;
    let currentIndex = 0;
    let currentSentence = "";
    let cancelDisplay = false;
    let displayElement;
    let answerBox;
    let currentAnswer = "";
    let currentMode = "all";
    let currentQAIndex = null; // ← 表示中の問題のインデックス（追跡用）

    window.onload = () => {
      displayElement = document.getElementById("display");
      answerBox = document.querySelector(".answer-box");
      const saved = localStorage.getItem("qaList");
      if (saved) {
        qaList = JSON.parse(saved);
      }
      renderList();
    };

    function saveData() {
      localStorage.setItem("qaList", JSON.stringify(qaList));
    }

    function setMode(mode) {
      currentMode = mode;
      document.querySelectorAll(".mode-button").forEach(btn => btn.classList.remove("active"));
      if (mode === "all") {
        document.querySelectorAll(".mode-button")[0].classList.add("active");
        document.getElementById("qa-list").style.display = "none";
      } else if (mode === "notMemorized") {
        document.querySelectorAll(".mode-button")[1].classList.add("active");
        document.getElementById("qa-list").style.display = "none";
      } else if (mode === "list") {
        document.querySelectorAll(".mode-button")[2].classList.add("active");
        document.getElementById("qa-list").style.display = "block";
        renderList();
      }
    }

    async function start() {
  if (isRunning) {
    cancelDisplay = true;
    await sleep(10); // ← これで「直前の処理をキャンセルした時間」を確保
  }

  isPaused = false;
  displayElement.textContent = "";
  answerBox.textContent = "タップして答えを表示";
  currentIndex = 0;
  isRunning = true;
  cancelDisplay = false;
  currentQAIndex = null;

  let candidates = qaList;
  if (currentMode === "notMemorized") {
    candidates = qaList.map((q, i) => ({ ...q, index: i })).filter(q => !q.memorized);
  } else {
    candidates = qaList.map((q, i) => ({ ...q, index: i }));
  }

  if (candidates.length === 0) {
    displayElement.textContent = "問題がありません。";
    isRunning = false;
    return;
  }

  const qa = candidates[Math.floor(Math.random() * candidates.length)];
  currentSentence = qa.question;
  currentAnswer = qa.answer;
  currentQAIndex = qa.index;

  // チェックボックスの状態を更新
  document.getElementById("memorizedCheck").checked = qaList[currentQAIndex].memorized;

  while (currentIndex < currentSentence.length) {
    if (cancelDisplay) break;
    if (isPaused) {
      await sleep(100);
      continue;
    }
    displayElement.textContent += currentSentence[currentIndex];
    currentIndex++;
    await sleep(100); // 表示速度（ms）
  }

  isRunning = false;
}
    
    function togglePause() {
      isPaused = !isPaused;
    }

    function showAnswer() {
      if (currentAnswer !== "") {
        answerBox.textContent = currentAnswer;
      }
    }

    function renderList() {
      const container = document.getElementById("qa-list");
      let html = "<table><tr><th>問題</th><th>答え</th><th>覚えた</th></tr>";
      qaList.forEach((qa, index) => {
        html += `<tr>
          <td>${qa.question}</td>
          <td>${qa.answer}</td>
          <td><input type="checkbox" onchange="toggleMemorized(${index})" ${qa.memorized ? "checked" : ""}></td>
        </tr>`;
      });
      html += "</table>";
      container.innerHTML = html;
    }

    function toggleMemorized(index) {
      qaList[index].memorized = !qaList[index].memorized;
      saveData();
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
  </script>

</body>
</html>
